---
title: "Finnmaid-GETM"
author: "Jens Daniel Müller & Lara Burchardt"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Aim of the project

Two datasets are available describing key parameters of baltic sea. Observational data is provided by the VOS Finnmaid, measuring (amongst others) pCO2, O2, Temperature and Salinity every minute while commuting between Travemünde and Helsinki. Measurments are taken from the surface water. 
The second dataset is modelled data providing information and values for all water depths and locations in the baltic sea. 
The two datasets are to be compared with regards to their ability to describe primary production in the baltic sea and how close to each other measured and modelled data is.

The data is saved in the netcdf format. We describe how to read in the data, compare the relevant variables to finally viualize the relation between the two and to describe primary production in the Baltic Sea.

The documnetation of the project is realized with `workflowr`, combining `R Markdown` with the version control Github as input for this webside. 

# Read Finnmaid data

The data from the VOS Finnmaid is read in from a netcdf file created by Bittig & Müller.

The following packages are needed: 

```{r library, message=FALSE, warning=FALSE} 
library(tidyverse)
library(ncdf4)
library(lubridate)
library(geosphere)
```

To open a file in the netcdf format we use the openning function of the ncdf4 package. With the function `file.choose()` the file can be chosen from an explorer window, independent of the files location. Shown here are two examples how to open the file.

```{r open1}
nc <- nc_open(file.choose())
```

```{r open2, eval = FALSE, echo= FALSE}

#nc <- nc_open("GETM/Finnmaid", "FM_all_2019_on_standard_tracks.nc")
```

First of all, we want to get an overview of the file.

```{r test}
print(nc)
attributes(nc$var)
attributes(nc$dim)
```

# Read GETM data

Now the real work starts. We want to prepare the data from the model to compare it later. 
We have some specifications, which files we want to look at first, because we only look at the models from a specific track, which is the Finnmaid track, route E. We want a list of all the files in our modeldata set, that include the `pattern = "Finnmaid.E.2d"`.
This pattern is to be searched for in all folders and subfolders of the current working directory, we achieve that by setting `recursive = TRUE`. 

```{r datapreparation, echo=FALSE}

filesList <- list.files(path= "data/GETM", pattern = "Finnmaid.E.2d", recursive = TRUE)
```

A few variable are to be specified for the following preparations.

```{r variables}

select_route <- "E"
low_lat <- 57.5
high_lat <- 58.5

```

We now loop through all the files in `fileList` we created before, to perform the data preparations and save the new arrays. 

```{r loop, eval = FALSE, echo = FALSE}

for (n in 7:length(filesList)) {

file <- filesList[n]

nc <- nc_open(paste("data/GETM/", file, sep = ""))

lon <- ncvar_get(nc, "lonc")
lat <- ncvar_get(nc, "latc", verbose = F)
time_units <- nc$dim$time$units

#t <- ymd_hms("2006-1-1 00:00:00") + ncvar_get(nc, "time")
t <- ymd_hms(time_units)
var <- "SST"

array <- ncvar_get(nc, var) # store the data in a 3-dimensional array
dim(array) # should be 2d with dimensions: 1575 coordinate, 31d*(24h/d/3h)=248 time steps

array <- as.data.frame(t(array), xy=TRUE)
array <- as_tibble(array)



SST_GETM <- array %>%
  set_names(as.character(lat)) %>%
  mutate(date_time = t) %>%
  gather("lat", "value", 1:length(lat)) %>%
  mutate(lat = as.numeric(lat)) %>%
  filter(lat > low_lat, lat<high_lat) %>%
  group_by(date_time) %>%
  summarise_all("mean") %>%
  ungroup() %>%
  mutate(var = var)


write.csv(SST_GETM, file = paste("Finnmaid_E_2d_", n,".csv", sep = ""), row.names= F, quote = F)

nc_close(nc)
rm(array, var, nc, t, lat, lon, SST_GETM)



}
```



# Compare SST readings

We want to compare the model data to the data actually measured by the VOS Finnmaid. Therefore, we need to prepare this data next.
The file we open is called "FM_all_2019_on_standard_tracks.nc" and contains information for the time between 2003 and 2019 for route E.

```{r finnmaid}


nc <- nc_open(file.choose())

#print(nc)
attributes(nc$var)
attributes(nc$dim)

# read required vectors from netcdf file
route <- ncvar_get(nc, "route")
route <- unlist(strsplit(route, ""))
date_time <- ncvar_get(nc, "time")
latitude_east <- ncvar_get(nc, "latitude_east")

var <- "SST_east"

  array <- ncvar_get(nc, var) # store the data in a 2-dimensional array
  #dim(array) # should have 2 dimensions: 544 coordinate, 2089 time steps
  
  fillvalue <- ncatt_get(nc, var, "_FillValue")
  array[array == fillvalue$value] <- NA
  rm(fillvalue)
  
  #i <- 5
  for (i in seq(1,length(route),1)){
    
    if(route[i] == select_route) {
      slice <- array[i,]
      
      value <- mean(slice[latitude_east > low_lat & latitude_east < high_lat], na.rm = TRUE)
      date <- ymd("2000-01-01") + date_time[i]
      
      temp <- bind_cols(date = date, var=var, value = value)
      
      if (exists("timeseries", inherits = FALSE)){
        timeseries <- bind_rows(timeseries, temp)
      } else{timeseries <- temp}
      
      rm(temp, value, date)
      
    } 
  }

nc_close(nc)
rm(list=setdiff(ls(), c("timeseries", "SST_GETM", "low_lat", "high_lat")))

timeseries_mean <- timeseries %>% 
  mutate(date_time = as.POSIXct(date)) %>% 
#mean of transects from finnmaid (ID)
  group_by(ID) %>% 
  summarise_all(list(~mean(.,na.rm = TRUE),
                     ~min(., na.rm= TRUE),
                     ~max(., na.rm= TRUE),
                     ~sd(., na.rm = TRUE))) 
```

To compare it with the model data, we -- for now -- open an examplary data file, we prepared in the previous steps.
Values are to be compared per day. Therefore, we need to calculate means per day before we continue. This is done on the example of the dataset "Finnmaid_E_2d_157.csv", that contains inforamtion for the whole year of 2006.

```{r dailymean}
SST_GETM_whole <- {}
SST_GETM_mean <- {}
for (n in 7:157) {
 SST_GETM <- read.csv(paste("Finnmaid_E_2d_", n ,".csv", sep = ""))
 SST_GETM_whole <- rbind(SST_GETM_whole, SST_GETM)
 
}

#SST_GETM <- read.csv("Finnmaid_E_2d_157.csv") #file nr 157 is the "GETM-test" dataset where data for a whole year was pooled
#SST_GETM$date_time <- as.POSIXct(SST_GETM$date_time)

#SST_GETM_whole <- as.POSIXct(SST_GETM_whole$date_time)

#timeseries <- timeseries %>%
#  mutate(date_time = as.POSIXct(date))

SST_GETM_mean <- SST_GETM_whole %>% 
  group_by(date_time) %>% 
  summarise_all(list(~mean(.,na.rm = TRUE)))

SST_GETM_mean$var <- "SST"

#comparison <- cbind(timeseries_mean,SST_GETM_mean)

```

Now we want to plot the SST against time for both timeseries: standard tracks of the VOS Finnmaid and the model data.
Unfortunatly the VOS Finnmaid did not observer continously in 2006, which is why there is a lot of missing data in this example. 

```{r plottimeseries}

if (exists("timeseries", inherits = FALSE)){
        timeseries <- bind_rows(timeseries, temp)
} else{timeseries <- SST_GETM_mean}

timeseries <- timeseries %>% 
  mutate(date_time = as.POSIXct(date_time))

timeseries_mean %>%

  filter(date_time >= ymd_h("2006-01-01 T00"),
         date_time <= ymd_h("2006-12-31 T24")) %>%
  ggplot()+
  geom_line(aes(date_time, value, col="Finnmaid"))+
  geom_point(aes(date_time, value, col="Finnmaid"))+
  geom_line(data=SST_GETM_mean, aes(date_time, value, col="GETM"))+
  labs(x="Date", y="SST (deg C)", title = paste("2006 | Finnmaid | Route E |",low_lat,"-",high_lat,"deg N"))+
  scale_x_datetime(date_breaks = "1 months", date_labels = "%b")+
  theme_bw()

```


