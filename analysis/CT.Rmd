---
title: "CT"
author: "Jens Daniel MÃ¼ller & Lara Burchardt"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r library, message=FALSE, warning=FALSE}

library(tidyverse)
library(ncdf4)
library(vroom) #'rlang' needs to be installed
library(lubridate)
library(geosphere)
library(dygraphs)
library(xts)
library(here)
library(metR)

```

```{r subsetting_criteria}

# route
select_route <- "E"

# variable names in 2d and 3d GETM files
var <- "SSS_east"

# latitude limits
low_lat <- 57.5
high_lat <- 58.5

```

# CT 

Here we calculate the mean salinity across all measurments made between march - september in the NGS subregion. 

```{r file_list_GETM_CT, eval=FALSE}

filesList_2d <- list.files(path= "data", pattern = "Finnmaid.E.2d.20", recursive = TRUE)

```

```{r read_sss_data_fm_ngs}

nc <- nc_open(paste("data/Finnmaid/", "FM_all_2019_on_standard_tracks.nc", sep = ""))

# read required vectors from netcdf file
route <- ncvar_get(nc, "route")
route <- unlist(strsplit(route, ""))
date_time <- ncvar_get(nc, "time")
latitude_east <- ncvar_get(nc, "latitude_east")

array <- ncvar_get(nc, var) # store the data in a 2-dimensional array
#dim(array) # should have 2 dimensions: 544 coordinate, 2089 time steps
  
  fillvalue <- ncatt_get(nc, var, "_FillValue")
  array[array == fillvalue$value] <- NA
  rm(fillvalue)
  
  #i <- 5
  for (i in seq(1,length(route),1)){
  
      
    if(route[i] == select_route) {
      slice <- array[i,]
      
      value <- mean(slice[latitude_east > low_lat & latitude_east < high_lat], na.rm = TRUE)
      sd    <- sd(slice[latitude_east > low_lat & latitude_east < high_lat], na.rm = TRUE)
      date <- ymd("2000-01-01") + date_time[i]
      
      temp <- bind_cols(date = date, var=var, value = value, sd = sd)
      
      if (exists("timeseries", inherits = FALSE)){
        timeseries <- bind_rows(timeseries, temp)
      } else{timeseries <- temp}
      
      rm(temp, value, date, sd)
      
    } 
  }
nc_close(nc)

fm_sss__ngs <- timeseries %>% 
  mutate(sss = value,
         year = year(date),
         month = month(date))

fm_sss_ngs_monthlymean <- fm_sss__ngs %>% 
  filter(month >=3 , month <=9) %>% 
  summarise(sss_mean = mean(sss, na.rm = TRUE))
```

The mean salinity between March and September for the NGS subregion for all years is `r fm_sss_ngs_monthlymean`.

# CT Plot

In the following section, we create a dygraph with two y-axis, combining the pCO2 measurments from VOS Finnmaid with the MLD5 calculations of the GETM Model.

```{r plot_mld__pco2_data_ngs}
gt_mld_fm_pco2_ngs <-
vroom::vroom(here::here("data/_merged_data_files/", file = "gt_mld_fm_pco2_ngs.csv"))



temperature <- ts(frequency = 12, start = c(1980, 1),
  data = c(7.0, 6.9, 9.5, 14.5, 18.2, 21.5, 
           25.2, 26.5, 23.3, 18.3, 13.9, 9.6))
rainfall <- ts(frequency = 12, start = c(1980, 1),
  data = c(49.9, 71.5, 106.4, 129.2, 144.0, 176.0, 
           135.6, 148.5, 216.4, 194.1, 95.6, 54.4))
weather <- cbind(rainfall, temperature)

# assign the "rainfall" series to the y2 axis
dygraph(weather) %>%
  dySeries("rainfall", axis = 'y2')
```
